# RuleGo Wait 同步/异步执行机制详解

阿沃，`wait` 参数是 Endpoint 路由配置中影响系统架构和用户体验最关键的配置项之一。配置错误会导致接口超时、数据丢失或响应内容为空。

---

## 🚀 1. `wait` 的核心定义

在 Endpoint 的 `routers` 配置中，`to` 对象下的 `wait` 字段决定了 **入口协议（如 HTTP）如何与规则链交互**。

```json
"to": {
  "path": "chain:main_logic",
  "wait": true 
}
```

### 🔹 wait: true (同步等待模式)
- **行为**: Endpoint 会“挂起”当前的请求连接，一直等到规则链完整处理结束（到达结束节点或最后一个节点）。
- **数据流**: 规则链执行结果的 `msg.Data` 和 `metadata` 可以通过后置处理器（如 `responseToBody`）返回给调用方。
- **优点**: 调用方可以立即拿到处理结果，适合“查询”、“即时计算”。
- **风险**: 
    - 如果规则链执行时间过长（如超过 HTTP 超时时间），调用方会收到 `504 Gateway Timeout`。
    - **严禁**在此模式下进行耗时数分钟的任务（如大文件处理、大规模扫描）。

### 🔹 wait: false (异步触发模式)
- **行为**: Endpoint 只要成功将消息投递到规则链的起始节点，就会立刻向调用方返回 `200 OK` (或对应的成功状态)。规则链在后台异步执行。
- **数据流**: 调用方拿不到规则链的处理结果。即使配置了 `responseToBody`，返回的内容通常也是空的或初始请求数据。
- **优点**: 极高的响应速度，吞吐量大。适合“数据采集”、“日志上报”、“状态通知”。
- **建议**: 异步模式下如果需要通知结果，应由规则链内部通过 `mqttClient`, `restApiCall` 或 `wechat/push` 等方式主动回调。

---

## 🛠️ 2. 与各 Endpoint 类型的结合

### 🌐 HTTP (endpoint/http)
| Wait 值 | 客户端表现 | 典型用途 |
|:---|:---|:---|
| `true` | 等待规则链结果。可搭配 `responseToBody` 返回 JSON。 | 获取验证码、查询数据库。 |
| `false` | 立即返回 `200 OK`。无法拿到链的修改结果。 | 接收 Webhook、上报传感器数据。 |

### ⏰ 定时任务 (endpoint/schedule)
| Wait 值 | 表现 | 典型用途 |
|:---|:---|:---|
| `true` | 本次任务执行完，才释放 Cron 协程。如果执行时间超过间隔，可能阻塞下次触发。 | 要求严格顺序执行的任务。 |
| `false` | 触发规则链后立即准备下次计时。 | 绝大多数定时采集/清理任务（**推荐**）。 |

### 📨 消息队列 (MQTT / Kafka / NATS)
- **通用原则**: 建议设为 `false`。
- **原因**: 消息队列本身就是异步架构。Endpoint 读取消息后应尽快回复 Ack（如果协议需要），而不是让消息队列的消费者连接挂起等待。

---

## ⚠️ 3. 常见避坑指南

### ❌ 坑 1：设置了 `wait: false` 却抱怨拿不到返回结果
- **现象**: HTTP 结果永远是 `{}` 或 200。
- **根因**: 异步模式下 Endpoint 不关心链的结果。
- **解决**: 将 `wait` 设为 `true`。

### ❌ 坑 2：在 `wait: true` 的链中包含阻塞节点
- **现象**: 规则链中有 `restApiCall` 调用一个极慢的第三方接口，导致 RuleGo 接口频繁超时。
- **解决**: 若不关注结果，改为 `wait: false`；若必须关注，通过分治法或 `join` 节点优化并发，并设置合理的超时时间。

---

## 🎯 4. 选择金标准

阿沃，当你犹豫要不要设为 `true` 时，问自己一个问题：
**“这次请求的发起者，如果拿不到处理后的结果，他还走得下去吗？”**

1. 如果他需要结果才能渲染 UI -> **必须 `wait: true`**。
2. 如果他只是‘告知’服务器发生了什么 -> **请务必 `wait: false`**。

阿沃，选错这个参数会导致性能下降 10 倍以上，请务必三思！
